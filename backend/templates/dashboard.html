{% extends "base.html" %}

{% block content %}
<div class="space-y-10">
    <h2 class="text-3xl font-extrabold text-gray-900">Library Dashboard</h2>

    <!-- Admin Link -->
    {% if role == 'admin' %}
    <div class="bg-yellow-100 p-4 rounded-xl shadow-md border border-yellow-300 flex justify-between items-center">
        <p class="font-medium text-yellow-800">You are an Admin. Access the Book Management Panel.</p>
        <a href="{{ url_for('admin.admin_panel') }}" class="py-2 px-4 rounded-lg bg-yellow-500 text-white font-semibold hover:bg-yellow-600 transition duration-150 shadow-md">
            Admin Panel
        </a>
    </div>
    {% endif %}

    <!-- Search Section -->
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Search Catalog</h3>
        <form method="GET" action="{{ url_for('main.dashboard') }}" class="flex space-x-2">
            <input type="text" name="query" placeholder="Search by Title, Author, or Genre..." 
                   class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                Search
            </button>
        </form>
    </div>

    <!-- Book List Section -->
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Available Books ({{ books|length }})</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Genre</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Available</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for book in books %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ book.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ book.author }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ book.genre }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold 
                            {% if book.available_copies > 0 %} text-green-600 {% else %} text-red-600 {% endif %}">
                            {{ book.available_copies }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            {% if book.available_copies > 0 %}
                                <a href="{{ url_for('main.borrow', book_id=book.id) }}" 
                                   class="text-indigo-600 hover:text-indigo-900 bg-indigo-100 py-1 px-3 rounded-lg transition duration-150">
                                    Borrow
                                </a>
                            {% else %}
                                <span class="text-gray-400 bg-gray-100 py-1 px-3 rounded-lg">Out of Stock</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not books %}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No books found matching your search.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- User Borrowing Status Section -->
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">My Borrowing Status ({{ borrowings|length }})</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Book Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Borrow Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in borrowings %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.book.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.borrow_date.strftime('%Y-%m-%d') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold 
                            {% if item.status == 'borrowed' %} text-red-600 {% else %} text-green-600 {% endif %}">
                            {{ item.status.capitalize() }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            {% if item.status == 'borrowed' %}
                                <a href="{{ url_for('main.return_book_route', book_id=item.book_id) }}" 
                                   class="text-green-600 hover:text-green-900 bg-green-100 py-1 px-3 rounded-lg transition duration-150">
                                    Return
                                </a>
                            {% else %}
                                <span class="text-gray-400">Returned on {{ item.return_date.strftime('%Y-%m-%d') }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not borrowings %}
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">You have no borrowing records.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% if role != 'admin' %}
    <!-- Account Deletion Button -->
    <div class="flex justify-end mb-4">
        <button id="delete-account-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md">Delete My Account</button>
    </div>
    {% endif %}
</div>
<script>
// Account deletion logic
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('delete-account-btn');
    if (btn) {
        btn.addEventListener('click', function() {
            if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
            fetch('/api/users/me', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin'
            })
            .then(res => res.json().then(data => ({ status: res.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    alert('Account deleted. You will be logged out.');
                    window.location.href = '/';
                } else {
                    alert(body.error || 'Failed to delete account.');
                }
            })
            .catch(() => alert('Failed to delete account.'));
        });
    }
});
</script>
{% endblock %}
