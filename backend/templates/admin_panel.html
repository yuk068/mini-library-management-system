{% extends "base.html" %}
{% block content %}
<!-- Book Management Section -->
<div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-10">
    <h3 class="text-xl font-semibold text-indigo-600 mb-4">Book Management</h3>
    <!-- Add Book Form -->
    <form method="POST" action="{{ url_for('admin.add_book') }}" class="flex flex-wrap gap-4 items-end mb-6">
        <input name="title" required placeholder="Title" class="border rounded px-3 py-2" />
        <input name="author" required placeholder="Author" class="border rounded px-3 py-2" />
        <input name="genre" required placeholder="Genre" class="border rounded px-3 py-2" />
        <input name="copies" required type="number" min="1" value="1" placeholder="Copies" class="border rounded px-3 py-2 w-24" />
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">Add Book</button>
    </form>
    <!-- Book List Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Author</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Genre</th>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Total</th>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Available</th>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for book in books %}
                <tr>
                    <form method="POST" action="{{ url_for('admin.edit_book', book_id=book.id) }}" class="contents">
                        <td class="px-4 py-2"><input name="title" value="{{ book.title }}" class="border rounded px-2 py-1 w-full" required /></td>
                        <td class="px-4 py-2"><input name="author" value="{{ book.author }}" class="border rounded px-2 py-1 w-full" required /></td>
                        <td class="px-4 py-2"><input name="genre" value="{{ book.genre }}" class="border rounded px-2 py-1 w-full" required /></td>
                        <td class="px-4 py-2 text-center"><input name="copies" type="number" min="1" value="{{ book.total_copies }}" class="border rounded px-2 py-1 w-16 text-center" required /></td>
                        <td class="px-4 py-2 text-center">{{ book.available_copies }}</td>
                        <td class="px-4 py-2 text-center flex gap-2 justify-center">
                            <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 font-semibold">Save</button>
                    </form>
                    <form method="POST" action="{{ url_for('admin.delete_book_route', book_id=book.id) }}" class="inline">
                        <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 font-semibold" onclick="return confirm('Delete this book?');">Delete</button>
                    </form>
                        </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="space-y-10">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-extrabold text-gray-900">User and Borrowing Logs</h2>
        <div class="flex space-x-2">
            <a href="{{ url_for('main.dashboard') }}" 
               class="py-2 px-4 rounded-lg bg-gray-500 text-white font-semibold hover:bg-gray-600 transition duration-150 shadow-md">
            ← Back to Dashboard
            </a>
        </div>
    </div>

    <!-- User Log Table -->
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 class="text-xl font-semibold text-indigo-600 mb-4">Registered Users & Activity Summary</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            User ID / Username
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Role
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Total Borrows
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Currently Borrowed
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Active Book Titles
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for user in user_logs %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            #{{ user.id }} - {{ user.username }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-semibold 
                            {% if user.role == 'admin' %} text-yellow-600 {% else %} text-indigo-600 {% endif %}">
                            {{ user.role.capitalize() }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-700">
                            {{ user.total_borrowed }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold 
                            {% if user.active_borrowings_count > 0 %} text-red-600 {% else %} text-green-600 {% endif %}">
                            {{ user.active_borrowings_count }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {% for item in user.history %}
                                {% if item.status == 'borrowed' %}
                                    <span class="block text-xs font-medium text-gray-800">{{ item.book.title }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if user.active_borrowings_count == 0 %}
                                <span class="text-xs italic text-gray-400">None currently active.</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detailed Log History -->
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 class="text-xl font-semibold text-indigo-600 mb-4">Detailed Borrowing History</h3>

        {% for user in user_logs %}
        <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h4 class="text-lg font-bold text-gray-800 mb-3">{{ user.username }}'s Log ({{ user.total_borrowed }} total actions)</h4>

            {% if user.total_borrowed > 0 %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-white">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Book</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Borrow Date</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Return Date</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for item in user.history|sort(attribute='borrow_date', reverse=true) %}
                        <tr>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.book.title }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">{{ item.borrow_date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                                {% if item.return_date %}{{ item.return_date.strftime('%Y-%m-%d %H:%M') }}{% else %}—{% endif %}
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-semibold 
                                {% if item.status == 'borrowed' %} text-red-600 {% else %} text-green-600 {% endif %}">
                                {{ item.status.capitalize() }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-sm italic text-gray-500">No borrowing records found for this user.</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
